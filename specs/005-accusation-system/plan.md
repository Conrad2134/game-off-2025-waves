# Implementation Plan: Accusation System

**Branch**: `005-accusation-system` | **Date**: 2025-11-12 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/005-accusation-system/spec.md`

**Note**: This plan was generated by the `/speckit.plan` command and includes Phase 0 (Research) and Phase 1 (Design) outputs.

## Summary

The accusation system provides the climax and win/lose conditions for the mystery game. Players interact with Valentin to accuse a suspect, then engage in a Phoenix Wright-style confrontation where they present evidence from their notebook to prove their case. The system tracks accusation attempts (max 2 failures before bad ending), validates evidence requirements, and triggers either a victory sequence (correct accusation with all evidence) or bad ending (2 failed accusations). All confrontation sequences, evidence requirements, and ending dialogs are data-driven via JSON configuration, allowing the guilty culprit to be changed without code modifications. The UI renders inline within the library scene as overlays, reusing the existing notebook component for evidence selection and following established Phaser 3 architecture patterns.

## Technical Context

**Language/Version**: TypeScript 5.0+ (ES2020 target, strict mode enabled)  
**Primary Dependencies**: Phaser 3.80.0 (game framework), Vite 5.0.0 (build tool)  
**Storage**: Browser LocalStorage for save state persistence, JSON data files for game content (character dialogs, clues, confrontation sequences)  
**Testing**: Manual playtesting of accusation flows, critical state management validation  
**Target Platform**: Web browsers (Chrome, Firefox, Safari, Edge)
**Project Type**: Single web application (Phaser 3 game)  
**Performance Goals**: 60 fps gameplay, <1s UI response times, <0.5s notebook opening  
**Constraints**: Pixel-perfect rendering (pixelArt: true, integer coordinates), offline-capable after initial load, <200MB total asset size  
**Scale/Scope**: Single-player mystery game, 5 NPCs, 1 library scene, 5 confrontation sequences, 2 ending sequences

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Principle I: Phaser 3 Architecture First ✅
- Accusation UI will be implemented as Phaser Scene components (overlays on LibraryScene)
- AccusationManager will be a system managing state and transitions
- Confrontation UI components will use Phaser Containers for layout
- Follows scene-entity-system architecture

### Principle II: Pixel Art Rendering Standards ✅
- All accusation UI sprites will use integer coordinates
- Portrait rendering will maintain pixelArt: true settings
- No violations of rendering standards

### Principle III: Data-Driven Design ✅
- Confrontation sequences defined in JSON (e.g., `src/data/accusation.json`)
- Culprit identity and evidence requirements configurable via JSON
- Victory/bad ending dialog defined in data files
- NPC reactions stored in character dialog JSON files

### Principle IV: Robust Error Handling ✅
- LocalStorage save/load operations will be wrapped in try-catch
- Missing accusation data files will have fallback error messages
- Invalid evidence presentation will be handled gracefully

### Principle V: Performance Through Pooling ✅
- Confrontation UI elements (statement boxes, evidence selectors) will use Phaser Groups
- Notebook overlay during confrontation reuses existing notebook system
- No performance concerns with accusation system

### Principle VI: TypeScript Type Safety ✅
- All accusation state and configuration will have TypeScript interfaces
- Type definitions for AccusationState, ConfrontationSequence, EvidenceRequirement
- Strict null checks maintained throughout

### Principle VII: Scene State Management ✅
- Accusation progress tracked via GameStateManager singleton
- Failed accusation counts persisted in LocalStorage
- Event-driven updates for UI state changes (scene.events.emit/on)

### Principle VIII: AI-Assisted Asset Generation ⚠️
- Not applicable for this feature (uses existing character portraits and UI elements)
- May need new UI sprites for confrontation interface (evidence selector, statement boxes)
- Consider PixelLab for any new UI assets if needed

**Status**: All gates PASS. No violations requiring justification.

## Project Structure

### Documentation (this feature)

```text
specs/[###-feature]/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (/speckit.plan command)
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

```text
src/
├── main.ts                              # Phaser game initialization
├── scenes/
│   ├── start-scene.ts                   # Title screen
│   └── library-scene.ts                 # Main investigation scene (accusation UI overlays here)
├── entities/
│   ├── player-character.ts              # Player entity
│   └── npc-character.ts                 # NPC entities (including Valentin)
├── components/
│   ├── dialog-box.ts                    # Existing dialog component
│   ├── notebook-ui.ts                   # Existing notebook component (reused for evidence selection)
│   ├── accusation-ui.ts                 # NEW: Main accusation/confrontation interface
│   └── ending-sequence.ts               # NEW: Victory/bad ending UI
├── systems/
│   ├── dialog-manager.ts                # Existing dialog system
│   ├── game-progression-manager.ts      # Existing progression system
│   ├── accusation-manager.ts            # NEW: Core accusation logic
│   └── save-manager.ts                  # Existing save/load system (extended for accusation state)
├── data/
│   ├── dialogs/
│   │   └── valentin.json                # Extended with accusation initiation dialog
│   ├── clues.json                       # Existing clues data
│   ├── progression.json                 # Existing progression data
│   └── accusation.json                  # NEW: Confrontation sequences, evidence requirements, endings
└── types/
    ├── dialog.ts                        # Existing dialog types
    ├── clue.ts                          # Existing clue types
    ├── progression.ts                   # Existing progression types
    └── accusation.ts                    # NEW: Accusation system types

tests/
└── manual/                              # Manual playtesting checklists
    └── accusation-flows.md              # Test scenarios for accusation system
```

**Structure Decision**: Single web application structure using existing Phaser 3 game organization. The accusation system integrates into the existing library scene as UI overlays, following the established pattern of components rendering within scenes. New components and systems added to existing directories to maintain consistency with features 001-004.

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| [e.g., 4th project] | [current need] | [why 3 projects insufficient] |
| [e.g., Repository pattern] | [specific problem] | [why direct DB access insufficient] |
